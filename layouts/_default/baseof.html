<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ if .Title }}{{ .Title }} | {{ end }}{{ .Site.Title }}</title>
    <meta name="description" content="{{ with .Description }}{{ . }}{{ else }}{{ .Site.Params.description }}{{ end }}">
    
    <!-- SEO Meta Tags -->
    <meta property="og:title" content="{{ if .Title }}{{ .Title }}{{ else }}{{ .Site.Title }}{{ end }}">
    <meta property="og:description" content="{{ with .Description }}{{ . }}{{ else }}{{ .Site.Params.description }}{{ end }}">
    <meta property="og:image" content="{{ .Site.BaseURL }}og-image.png">
    <meta property="og:url" content="{{ .Permalink }}">
    <meta property="og:type" content="website">
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{ if .Title }}{{ .Title }}{{ else }}{{ .Site.Title }}{{ end }}">
    <meta name="twitter:description" content="{{ with .Description }}{{ . }}{{ else }}{{ .Site.Params.description }}{{ end }}">
    <meta name="twitter:image" content="{{ .Site.BaseURL }}og-image.png">
    <meta name="twitter:creator" content="@theoblivionsage">
    
    <link rel="stylesheet" href="/css/terminal.css">
    <link rel="stylesheet" href="/css/custom.css">
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="canonical" href="{{ .Permalink }}">
    {{ with .OutputFormats.Get "rss" -}}
    <link rel="alternate" type="application/rss+xml" title="{{ $.Site.Title }}" href="{{ .Permalink }}">
    {{- end }}
</head>
<body>
    <!-- Progress Bar -->
    <div class="progress-bar" id="progress-bar"></div>

    <div class="container">
        <header class="terminal-header">
            <a href="/" class="logo-link">
                <span class="terminal-logo">root@oblivionsage<span class="cursor">_</span></span>
            </a>
            <span class="terminal-bar">||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||</span>
            <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
                <svg class="theme-icon" viewBox="0 0 100 100" width="24" height="24">
                    <circle cx="50" cy="50" r="45" fill="currentColor" stroke="currentColor" stroke-width="4"/>
                    <path d="M50 5 A45 45 0 0 1 50 95" fill="var(--background)"/>
                </svg>
            </button>
        </header>
        
        <nav class="nav">
            <a href="/">Home</a>
            <a href="/about/">About</a>
            <a href="/posts/">Posts</a>
            <a href="/tags/">Tags</a>
            <a href="/pgp/">PGP</a>
            <button class="search-btn" onclick="toggleSearch()">Search</button>
        </nav>

        <!-- Search Box -->
        <div class="search-container" id="search-container">
            <input type="text" id="search-input" placeholder="Search posts..." onkeyup="searchPosts()">
            <div class="search-results" id="search-results"></div>
        </div>

        <main>
            {{ block "main" . }}{{ end }}
        </main>

        <footer class="footer">
            <div class="footer-links">
                <a href="https://github.com/oblivionsage" target="_blank">GitHub</a>
                <a href="https://x.com/theoblivionsage" target="_blank">X</a>
                <a href="https://linkedin.com/in/haliloktay" target="_blank">LinkedIn</a>
                <a href="mailto:cookieandcream560@gmail.com">Email</a>
                <a href="/index.xml" target="_blank">RSS</a>
            </div>
            <p class="copyright">© 2025 oblivionsage. All rights reserved.</p>
        </footer>
    </div>

    <!-- Back to Top -->
    <button class="back-to-top" id="back-to-top" onclick="scrollToTop()">↑</button>

    <!-- Lightbox -->
    <div class="lightbox-overlay" id="lightbox" onclick="closeLightbox(event)">
        <button class="lightbox-close-btn" onclick="closeLightbox(event)">✕</button>
        <img class="lightbox-img" id="lightbox-img" src="" alt="" onclick="event.stopPropagation()">
    </div>

    <script>
        // Theme toggle
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);

        // Progress bar
        window.addEventListener('scroll', () => {
            const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
            const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
            const scrolled = (winScroll / height) * 100;
            document.getElementById('progress-bar').style.width = scrolled + '%';
            
            // Back to top visibility
            const btn = document.getElementById('back-to-top');
            if (winScroll > 300) {
                btn.classList.add('visible');
            } else {
                btn.classList.remove('visible');
            }
        });

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Search
        let searchIndex = [];

        async function loadSearchIndex() {
            try {
                const response = await fetch('/index.json');
                searchIndex = await response.json();
            } catch (e) {
                console.log('Search index not available');
            }
        }

        function toggleSearch() {
            const container = document.getElementById('search-container');
            container.classList.toggle('active');
            if (container.classList.contains('active')) {
                document.getElementById('search-input').focus();
            }
        }

        function searchPosts() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const results = document.getElementById('search-results');
            
            if (query.length < 2) {
                results.innerHTML = '';
                return;
            }

            const matches = searchIndex.filter(post => 
                post.title.toLowerCase().includes(query) ||
                post.content.toLowerCase().includes(query) ||
                (post.tags && post.tags.some(tag => tag.toLowerCase().includes(query)))
            );

            if (matches.length === 0) {
                results.innerHTML = '<div class="search-result-item">No results found</div>';
                return;
            }

            results.innerHTML = matches.map(post => 
                `<a href="${post.permalink}" class="search-result-item">
                    <span class="search-result-title">${post.title}</span>
                    <span class="search-result-date">${post.date}</span>
                </a>`
            ).join('');
        }

        // Close search on ESC
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') {
                document.getElementById('search-container').classList.remove('active');
                closeLightbox();
            }
        });

        // Load search index on page load
        loadSearchIndex();

        // Lightbox
        function openLightbox(img) {
            document.getElementById('lightbox-img').src = img.src;
            document.getElementById('lightbox').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeLightbox(e) {
            if (e) e.stopPropagation();
            document.getElementById('lightbox').classList.remove('active');
            document.body.style.overflow = '';
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Wrap images with expand hint
            document.querySelectorAll('article img').forEach(img => {
                const wrapper = document.createElement('div');
                wrapper.className = 'img-wrapper';
                img.parentNode.insertBefore(wrapper, img);
                wrapper.appendChild(img);
                
                const hint = document.createElement('span');
                hint.className = 'expand-hint';
                hint.innerHTML = '⤢ expand';
                wrapper.appendChild(hint);
                
                wrapper.addEventListener('click', () => openLightbox(img));
            });

            // Copy code button
            document.querySelectorAll('pre').forEach(block => {
                const btn = document.createElement('button');
                btn.className = 'copy-btn';
                btn.textContent = 'Copy';
                btn.onclick = () => {
                    navigator.clipboard.writeText(block.querySelector('code').textContent);
                    btn.textContent = 'Copied!';
                    setTimeout(() => btn.textContent = 'Copy', 2000);
                };
                block.style.position = 'relative';
                block.appendChild(btn);
            });
        });
    </script>
</body>
</html>
